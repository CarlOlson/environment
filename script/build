#!/usr/bin/env fish

cd (dirname (status --current-filename))/..

if uname -a | grep Darwin
    set -x PATH $HOME/.nix-profile/bin $PATH
end

if type -q emacs
    emacs -Q -nw --load pre-tangle.el --file init.org -f org-babel-tangle -f kill-emacs
end

if test -f $HOME/.emacs.d/init.el
    rm $HOME/.emacs.d/init.el
end

ln -s $PWD/init.el $HOME/.emacs.d/init.el

if type -q awesome && not awesome --check -c awesome/rc.lua
    echo "Bad awesome config!"
    exit 1
end

if home-manager switch -f home.nix
    if type -q awesome-client
        awesome-client "awesome.restart()"
    end

    source fish/config.fish

    echo "Success. Now restart emacs."
else
    exit 1
end
